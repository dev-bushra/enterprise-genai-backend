أكيد! راح أجهز لك وثيقة توثيق كاملة واضحة ومرتبة لحد الآن، بحيث أي مطور جديد يدخل المشروع يفهم كل شيء بسهولة، من البداية حتى الآن، مع شرح الخطوات، المكونات، وكيفية التعامل مع المشروع، وأيضًا الموارد الخارجية المستخدمة.

---

# توثيق مشروع FastAPI – نظام صلاحيات مؤسساتي (RBAC) – وثيقة شاملة

---

## 1. مقدمة عن المشروع

هذا المشروع هو نظام Backend متقدم باستخدام **FastAPI** لبناء API قوي ومؤمن بنظام صلاحيات متقدم (RBAC - Role-Based Access Control).
يهدف المشروع إلى:

* إدارة المستخدمين والصلاحيات بشكل مؤسسي.
* تأمين الوصول إلى الموارد حسب الأدوار (مثلاً مشرف، مستخدم عادي، عارض).
* توفير بنية قابلة للتوسع لمشاريع المؤسسات الكبيرة.
* دعم تكامل مع أنظمة خارجية مثل Google Login وAI workflows مستقبلًا.

---

## 2. التقنيات المستخدمة

| التقنية          | الاستخدام                            |
| ---------------- | ------------------------------------ |
| FastAPI          | إطار عمل ويب لبناء API حديث وسريع    |
| Python 3.11+     | لغة البرمجة الأساسية                 |
| SQLAlchemy       | ORM لإدارة قواعد البيانات            |
| PostgreSQL       | قاعدة البيانات العلائقية             |
| Alembic          | نظام إدارة ترحيلات قاعدة البيانات    |
| OAuth2 + JWT     | نظام التوثيق والتفويض                |
| Google OAuth2    | تسجيل الدخول عبر حساب Google         |
| Async SQLAlchemy | تنفيذ قواعد البيانات بشكل غير متزامن |
| Docker (مستقبلي) | لتسهيل النشر والتشغيل الحاوي         |

---

## 3. هيكلية المشروع (Structure)

```
app/
 ├── api/                  # تعريف نقاط النهاية (Routes)
 │    ├── tasks.py
 │    └── users.py
 ├── auth/                 # ملفات التوثيق و RBAC
 │    ├── oauth2.py
 │    ├── rbac.py
 │    └── deps.py
 ├── db/                   # قواعد البيانات والنماذج
 │    ├── models/
 │    │    ├── user.py
 │    │    ├── role.py
 │    │    └── user_role.py
 │    ├── database.py
 │    └── session.py
 ├── core/                 # الإعدادات الأساسية (Settings, Config)
 ├── main.py               # نقطة دخول التطبيق (FastAPI app)
 └── tests/                # اختبارات الوحدة (قيد التطوير)
```

---

## 4. ماذا قمنا به حتى الآن؟ الخطوات المنفذة

### 4.1 إعداد قاعدة البيانات

* استخدمنا **PostgreSQL** كقاعدة بيانات أساسية.
* أنشأنا نماذج **SQLAlchemy ORM** لـ:

  * المستخدمين (`User`)
  * الأدوار (`Role`)
  * العلاقة بين المستخدمين والأدوار (`UserRole`)
* استخدمنا **Alembic** لترحيل هذه النماذج إلى قاعدة البيانات.

### 4.2 بناء نظام RBAC

* تصميم جداول `roles` و `user_roles` مع علاقات **many-to-many** مع المستخدمين.
* ربط المستخدمين بالأدوار باستخدام العلاقة `roles` داخل نموذج `User`.
* إنشاء دوال مساعدة لجلب أدوار المستخدم من قاعدة البيانات.
* إنشاء Dependency في FastAPI لفحص صلاحيات المستخدم لكل نقطة نهاية.
* حماية الـ endpoints بحيث يمكن السماح فقط للمستخدمين الذين لديهم الأدوار المناسبة.
* دعم التكامل مع Google OAuth2 كطريقة تسجيل دخول (JWT).

---

## 5. كيف تستخدم النظام؟

### 5.1 التسجيل وتسجيل الدخول

* يعتمد تسجيل الدخول على Google OAuth2.
* بعد تسجيل الدخول، يحصل المستخدم على **JWT** يحتوي على بيانات المستخدم.
* يتم استخراج معرف المستخدم (user\_id) من التوكن.

### 5.2 إدارة الأدوار والصلاحيات

* يمكن ربط المستخدم بأدوار متعددة في جدول `user_roles`.
* في نقاط النهاية (`routes`) يمكن حماية الوصول بـ Dependency:
  `Depends(require_roles(["admin", "viewer"]))`
* إذا لم يمتلك المستخدم الدور المناسب، يتم إرجاع خطأ 403 Forbidden.

---

## 6. كيف تضيف أدوار جديدة؟

1. إنشاء سجل جديد في جدول `roles` بقاعدة البيانات (مثلاً: "admin", "user", "viewer").
2. ربط المستخدم بالأدوار في جدول `user_roles`.
3. تحديث التوكن إذا لزم الأمر (أو تحميل الأدوار عند كل طلب).
4. حماية نقاط النهاية باستخدام Dependency `require_roles`.

---

## 7. الموارد الخارجية المستخدمة

| المورد        | الغرض                                 |
| ------------- | ------------------------------------- |
| Google OAuth2 | تسجيل الدخول والتوثيق عبر حساب Google |
| PostgreSQL    | تخزين بيانات المستخدمين والأدوار      |
| Alembic       | إدارة ترحيلات قاعدة البيانات          |
| FastAPI       | إنشاء API سريعة وقابلة للتوسع         |

---

## 8. خطوات تشغيل المشروع

1. **إعداد البيئة الافتراضية**

```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
```

2. **تثبيت المتطلبات**

```bash
pip install -r requirements.txt
```

3. **تعديل إعدادات الاتصال بقاعدة البيانات** في `app/core/config.py` أو `app/db/database.py`.

4. **ترحيل قاعدة البيانات باستخدام Alembic**

```bash
alembic upgrade head
```

5. **تشغيل التطبيق**

```bash
uvicorn app.main:app --reload
```

6. **اختبار API باستخدام Postman أو أي أداة مشابهة.**

---

## 9. ماذا بعد؟

الخطوات القادمة لبناء المشروع:

* تصميم نظام **إدارة الـ AI Prompts** ليدعم عمليات الذكاء الاصطناعي.
* إضافة نظام **المهام الخلفية (Celery + Redis)** لمعالجة العمليات الثقيلة مثل: انتظار ردود الذكاء الاصطناعي، توليد ملفات، أو إرسال الإشعارات.

---

# ⚠️ ملحوظة هامة للمطور الجديد

* تأكد من فهم طريقة عمل OAuth2 وتوليد JWT.
* افهم كيف تعمل العلاقات بين الجداول في SQLAlchemy (especially many-to-many).
* كل endpoint محمي بـ Dependencies للتحقق من صلاحيات الوصول.
* ابحث دائمًا عن الأداء والأمان في كل تعديل جديد.

---

لو تحتاج أي توضيحات إضافية أو ملفات شرح جاهزة للمطورين الجدد، خبرني وأنا أجهزها لك فورًا!
